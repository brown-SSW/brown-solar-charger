<!DOCTYPE HTML>
<html>

<head>
    <script>
        var json_obj; //global variable to hold all the data recieved from the server
        updateData(); //call updateData once, to start it calling itself
        function updateData() {
            /**
             * this function runs periodically to refresh the page with new data
             */
            json_obj = JSON.parse(Get("http://bruno-sun.duckdns.org/data.json"));//update if the url of the station changes
            redraw(); //update everything now that we have new data

            setTimeout(updateData, 5000); //this makes the function repeat itself, maybe slow down after testing to reduce server load
        }


        function redraw() {
            document.getElementById("myvar").textContent = json_obj.time; //a way to display data as text
            drawGraph1(); //show a graph
            //add dashboard elements to update here
        }
        function drawGraph1() {
            // this was just to figure out some things
            // it should be replaced with a nicer general graphing function
            var graph1c = document.getElementById("graph1"); //get the canvas to draw to
            var graph1div = document.getElementById("graph1div"); //get the div the canvas is in
            // the next 5 lines make the canvas resize as the div it's in resizes
            graph1c.width = 0;
            graph1c.height = 0;
            graph1divproperties = window.getComputedStyle(graph1div, null);
            graph1c.width = parseInt(graph1divproperties.width);
            graph1c.height = parseInt(graph1divproperties.width) / 2;
            //next, draw to the canvas
            var ctx = graph1c.getContext("2d"); 
            ctx.fillStyle = "yellow";
            ctx.fillRect(0, 0, graph1c.width, graph1c.height); //dimensions should be in relation to canvas size for resizability
            ctx.fillStyle = "green";
            for (var i = 0; i < json_obj.graph1.length; i++) { //loop through a json array to show bar graph
                ctx.fillRect(graph1c.width * (i + 1) / (json_obj.graph1.length + 1), graph1c.height, graph1c.width / 2 / json_obj.graph1.length, -1.0 / 4096 * json_obj.graph1[i] * graph1c.height);
                //note: the -1.0 is to make the bars grow upwards, the 4096 relates to the scale-for testing that was the max value the esp32 could send, but this should be handled better
            }
        }

        function Get(yourUrl) {
            //this function was found somewhere. it is used in the json data getting code
            var Httpreq = new XMLHttpRequest();
            Httpreq.open("GET", yourUrl, false);
            Httpreq.send(null);
            return Httpreq.responseText;
        }
    </script>
</head>

<body onload="updateData()" onresize="redraw()">
    <!-- a grid-container is one way to display multiple objects in a resizable layout-->
    <div class="grid-container">
        <div class="val1div">
            <!-- myvar= is displayd as text, loading... is replaced as soon as data is received -->
            <h1> myvar= <span id="myvar">loading...</span></h1>
        </div>
        <div id="graph1div" class="graph1div">
            <canvas id="graph1"></canvas>
        </div>
    </div>
</body>

</html>